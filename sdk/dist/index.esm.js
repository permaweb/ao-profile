var T="https://arweave.net",c={profileSrc:"_R2XYWDPUXVvQrQKFaQRvDTDcDwnQNbqlTd_qvCRSpQ",module:"Pq2Zftrqut0hdisH_MC2pDOT6S4eQFoxGsFUzR6r350",scheduler:"_GQ33BkPtZrqxA84vM8Zk-N2aO0toNNu_C-l-rawrBA",profileRegistry:"SNy4m-DrqxWl01YqGM4sxI8qCni-58re8uuJLvZPypY"},d={arweave:"https://arweave.net",goldsky:"https://arweave-search.goldsky.com"},P={default:100,landing:{assets:30},collection:{assets:15},profile:{assets:15}},h={p1:"P1",end:"END"};function x(e){let r=e.paginator?e.paginator:P.default,n=e.ids?JSON.stringify(e.ids):null,t=null;e.minBlock!==void 0&&e.minBlock!==null&&(t={},t.min=e.minBlock);let o=t?JSON.stringify(t).replace(/"([^"]+)":/g,"$1:"):null,a=e.tagFilters?JSON.stringify(e.tagFilters).replace(/"(name)":/g,"$1:").replace(/"(values)":/g,"$1:").replace(/"FUZZY_OR"/g,"FUZZY_OR"):null,s=e.owners?JSON.stringify(e.owners):null,i=e.cursor&&e.cursor!==h.end?`"${e.cursor}"`:null,u=`first: ${r}`,g="",f="data { size type } owner { address } block { height timestamp }",y="";switch(e.gateway){case d.arweave:break;case d.goldsky:g="count";break}let l=`
		transactions(
				ids: ${n},
				tags: ${a},
				${u}
				owners: ${s},
				block: ${o},
				after: ${i},
				${y}
				
			){
			${g}
				pageInfo {
					hasNextPage
				}
				edges {
					cursor
					node {
						id
						tags {
							name 
							value 
						}
						${f}
					}
				}
		}`;return e.queryKey&&(l=`${e.queryKey}: ${l}`),l}async function O(e){try{return await(await fetch(`${e.gateway}/graphql`,{method:"POST",headers:{"Content-Type":"application/json"},body:e.query})).json()}catch(r){throw r}}function b(e){let r={query:`query { ${e} }`};return JSON.stringify(r)}async function v(e){let r=e.paginator?e.paginator:P.default,n=[],t=0,o=null;if(e.ids&&!e.ids.length)return{data:n,count:t,nextCursor:o,previousCursor:null};try{let a=x(e),s=await O({gateway:e.gateway,query:b(a)});return s.data.transactions.edges.length?(n=[...s.data.transactions.edges],t=s.data.transactions.count??0,n.length<r||!s.data.transactions.pageInfo.hasNextPage?o=h.end:o=n[n.length-1].cursor,{data:n,count:t,nextCursor:o,previousCursor:null}):{data:n,count:t,nextCursor:o,previousCursor:null}}catch(a){return console.error(a),{data:n,count:t,nextCursor:o,previousCursor:null}}}function w(e,r){for(let n=0;n<e.length;n++)if(e[n]&&e[n].name===r)return e[n].value;return null}async function I(e){try{let r=[{name:"Action",value:e.action}];e.tags&&r.push(...e.tags);let n=e.data,t=await e.ao.message({process:e.processId,signer:e.signer,tags:r,data:n}),{Messages:o}=await e.ao.result({message:t,process:e.processId});if(o&&o.length){let a={};return o.forEach(s=>{let i=w(s.Tags,"Action")||e.action,u=null,g=s.Data;if(g)try{u=JSON.parse(g)}catch{u=g}let f=w(s.Tags,"Status"),y=w(s.Tags,"Message");a[i]={id:t,status:f,message:y,data:u}}),a}else return null}catch(r){console.error(r)}}function p(e){return Object.fromEntries(Object.entries(e).map(([r,n])=>[r.charAt(0).toUpperCase()+r.slice(1),n]))}async function m(e){let r=[{name:"Action",value:e.action}];e.tags&&r.push(...e.tags);let n=JSON.stringify(e.data||{}),t=await e.ao.dryrun({process:e.processId,tags:r,data:n});if(t.Messages&&t.Messages.length){if(t.Messages[0].Data)return JSON.parse(t.Messages[0].Data);if(t.Messages[0].Tags)return t.Messages[0].Tags.reduce((o,a)=>(o[a.name]=a.value,o),{})}}function A(e){return async r=>{let n={id:r.profileId,walletAddress:null,displayName:null,username:null,bio:null,avatar:null,banner:null,version:null};try{let t=await m({processId:r.profileId,action:"Info",data:null,ao:e.ao});return t?{id:r.profileId,walletAddress:t.Owner||null,displayName:t.Profile.DisplayName||null,username:t.Profile.UserName||null,bio:t.Profile.Description||null,avatar:t.Profile.ProfileImage||null,banner:t.Profile.CoverImage||null,version:t.Profile.Version||null,assets:t.Assets?.map(o=>o.Id)??[]}:n}catch(t){throw new Error(t)}}}function S(e){return async r=>{let n={id:null,walletAddress:r.address,displayName:null,username:null,bio:null,avatar:null,banner:null,version:null};try{let t=await m({processId:e.registry?e.registry:c.profileRegistry,action:"Get-Profiles-By-Delegate",data:{Address:r.address},ao:e.ao}),o=null;if(t&&t.length>0&&t[0].ProfileId&&(o=t[0].ProfileId),o){let a=await m({processId:o,action:"Info",data:null,ao:e.ao});return a?{id:o,walletAddress:a.Owner||null,displayName:a.Profile.DisplayName||null,username:a.Profile.UserName||null,bio:a.Profile.Description||null,avatar:a.Profile.ProfileImage||null,banner:a.Profile.CoverImage||null,version:a.Profile.Version||null,assets:a.Assets?.map(i=>i.Id)??[]}:n}else return n}catch(t){throw new Error(t)}}}function N(e){return async r=>{try{let n=await m({processId:e.registry?e.registry:c.profileRegistry,action:"Get-Metadata-By-ProfileIds",data:{ProfileIds:r.profileIds},ao:e.ao});return n&&n.length?r.profileIds.map(t=>{let o=n.find(a=>a.ProfileId===t);return{id:o?o.ProfileId:t,username:o?o.Username:null,avatar:o?o.ProfileImage:null,bio:o?o.Description??null:null,lastUpdate:Date.now()}}):[]}catch(n){throw new Error(n)}}}function C(e){return async r=>{try{let n=r.profileSrc?r.profileSrc:c.profileSrc,t=await fetch(`${e.arweaveUrl}/${n}`);if(!t.ok)throw new Error("Error fetching the process source code.");let o=await t.text(),s=[{name:"Date-Created",value:new Date().getTime().toString()},{name:"Action",value:"Create-Profile"}];e.logging&&console.log("Spawning profile process...");let i=await e.ao.spawn({module:r.module?r.module:c.module,scheduler:r.scheduler?r.scheduler:c.scheduler,signer:e.signer,tags:s,data:JSON.stringify(p(r.data))});e.logging&&console.log("Process Id -",i),e.logging&&console.log("Fetching profile process...");let u=null,g=0;for(;!u;){await new Promise(R=>setTimeout(R,2e3));let l=await v({gateway:e.graphqlUrl,ids:[i],tagFilters:null,owners:null,cursor:null});if(l&&l.data.length)e.logging&&console.log("Fetched transaction -",l.data[0].node.id),u=l.data[0].node.id;else if(e.logging&&console.log("Transaction not found -",i),g++,g>=200)throw new Error("Profile not found, please try again")}e.logging&&console.log("Sending source eval...");let f=await e.ao.message({process:i,signer:e.signer,tags:[{name:"Action",value:"Eval"}],data:o});e.logging&&console.log(f);let y=await e.ao.result({message:f,process:i});return e.logging&&console.log(y),await new Promise(l=>setTimeout(l,1e3)),e.logging&&console.log("Updating profile data..."),await I({processId:i,action:"Update-Profile",tags:null,data:JSON.stringify(p(r.data)),ao:e.ao,signer:e.signer}),i}catch(n){throw new Error(n)}}}function D(e){return async r=>(e.logging&&console.log(`Updating Profile ${r.profileId}`),(await I({processId:r.profileId,action:"Update-Profile",tags:[{name:"ProfileProcess",value:r.profileId}],data:JSON.stringify(p(r.data)),ao:e.ao,signer:e.signer}))["Profile-Success"]?.id)}var B=e=>({create:C({ao:e.ao,signer:e.signer,arweaveUrl:e?.arweaveUrl?e.arweaveUrl:T,graphqlUrl:e?.graphqlUrl?e.graphqlUrl:d.goldsky,logging:e.logging}),update:D({ao:e.ao,signer:e.signer,logging:e.logging}),getById:A({ao:e.ao,registry:e.registry}),getByWallet:S({ao:e.ao,registry:e.registry}),getRegistryProfiles:N({ao:e.ao,registry:e.registry})});export{B as init};
//# sourceMappingURL=index.esm.js.map
