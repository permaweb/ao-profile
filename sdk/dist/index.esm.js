var T="https://arweave.net",c={profileSrc:"_R2XYWDPUXVvQrQKFaQRvDTDcDwnQNbqlTd_qvCRSpQ",module:"Pq2Zftrqut0hdisH_MC2pDOT6S4eQFoxGsFUzR6r350",scheduler:"_GQ33BkPtZrqxA84vM8Zk-N2aO0toNNu_C-l-rawrBA",profileRegistry:"SNy4m-DrqxWl01YqGM4sxI8qCni-58re8uuJLvZPypY"},p={arweave:"https://arweave.net",goldsky:"https://arweave-search.goldsky.com"},P={default:100,landing:{assets:30},collection:{assets:15},profile:{assets:15}},h={p1:"P1",end:"END"};function x(e){let t=e.paginator?e.paginator:P.default,n=e.ids?JSON.stringify(e.ids):null,r=null;e.minBlock!==void 0&&e.minBlock!==null&&(r={},r.min=e.minBlock);let o=r?JSON.stringify(r).replace(/"([^"]+)":/g,"$1:"):null,a=e.tagFilters?JSON.stringify(e.tagFilters).replace(/"(name)":/g,"$1:").replace(/"(values)":/g,"$1:").replace(/"FUZZY_OR"/g,"FUZZY_OR"):null,s=e.owners?JSON.stringify(e.owners):null,i=e.cursor&&e.cursor!==h.end?`"${e.cursor}"`:null,g=`first: ${t}`,u="",f="data { size type } owner { address } block { height timestamp }",d="";switch(e.gateway){case p.arweave:break;case p.goldsky:u="count";break}let l=`
		transactions(
				ids: ${n},
				tags: ${a},
				${g}
				owners: ${s},
				block: ${o},
				after: ${i},
				${d}
				
			){
			${u}
				pageInfo {
					hasNextPage
				}
				edges {
					cursor
					node {
						id
						tags {
							name 
							value 
						}
						${f}
					}
				}
		}`;return e.queryKey&&(l=`${e.queryKey}: ${l}`),l}async function O(e){try{return await(await fetch(`${e.gateway}/graphql`,{method:"POST",headers:{"Content-Type":"application/json"},body:e.query})).json()}catch(t){throw t}}function b(e){let t={query:`query { ${e} }`};return JSON.stringify(t)}async function v(e){let t=e.paginator?e.paginator:P.default,n=[],r=0,o=null;if(e.ids&&!e.ids.length)return{data:n,count:r,nextCursor:o,previousCursor:null};try{let a=x(e),s=await O({gateway:e.gateway,query:b(a)});return s.data.transactions.edges.length?(n=[...s.data.transactions.edges],r=s.data.transactions.count??0,n.length<t||!s.data.transactions.pageInfo.hasNextPage?o=h.end:o=n[n.length-1].cursor,{data:n,count:r,nextCursor:o,previousCursor:null}):{data:n,count:r,nextCursor:o,previousCursor:null}}catch(a){return console.error(a),{data:n,count:r,nextCursor:o,previousCursor:null}}}function w(e,t){for(let n=0;n<e.length;n++)if(e[n]&&e[n].name===t)return e[n].value;return null}async function I(e){try{let t=[{name:"Action",value:e.action}];e.tags&&t.push(...e.tags);let n=e.data,r=await e.ao.message({process:e.processId,signer:e.signer,tags:t,data:n}),{Messages:o}=await e.ao.result({message:r,process:e.processId});if(o&&o.length){let a={};return o.forEach(s=>{let i=w(s.Tags,"Action")||e.action,g=null,u=s.Data;if(u)try{g=JSON.parse(u)}catch{g=u}let f=w(s.Tags,"Status"),d=w(s.Tags,"Message");a[i]={id:r,status:f,message:d,data:g}}),a}else return null}catch(t){console.error(t)}}function y(e){return Object.fromEntries(Object.entries(e).map(([t,n])=>[t.charAt(0).toUpperCase()+t.slice(1),n]))}async function m(e){let t=[{name:"Action",value:e.action}];e.tags&&t.push(...e.tags);let n=JSON.stringify(e.data||{}),r=await e.ao.dryrun({process:e.processId,tags:t,data:n});if(r.Messages&&r.Messages.length){if(r.Messages[0].Data)return JSON.parse(r.Messages[0].Data);if(r.Messages[0].Tags)return r.Messages[0].Tags.reduce((o,a)=>(o[a.name]=a.value,o),{})}}function A(e){return async t=>{let n={id:t.profileId,walletAddress:null,displayName:null,username:null,bio:null,avatar:null,banner:null,version:null};try{let r=await m({processId:t.profileId,action:"Info",data:null,ao:e.ao});return r?{id:t.profileId,walletAddress:r.Owner||null,displayName:r.Profile.DisplayName||null,username:r.Profile.UserName||null,bio:r.Profile.Description||null,avatar:r.Profile.ProfileImage||null,banner:r.Profile.CoverImage||null,version:r.Profile.Version||null,assets:r.Assets?.map(o=>o.Id)??[]}:n}catch(r){throw new Error(r)}}}function S(e){return async t=>{let n={id:null,walletAddress:t.address,displayName:null,username:null,bio:null,avatar:null,banner:null,version:null};try{let r=await m({processId:c.profileRegistry,action:"Get-Profiles-By-Delegate",data:{Address:t.address},ao:e.ao}),o=null;if(r&&r.length>0&&r[0].ProfileId&&(o=r[0].ProfileId),o){let a=await m({processId:o,action:"Info",data:null,ao:e.ao});return a?{id:o,walletAddress:a.Owner||null,displayName:a.Profile.DisplayName||null,username:a.Profile.UserName||null,bio:a.Profile.Description||null,avatar:a.Profile.ProfileImage||null,banner:a.Profile.CoverImage||null,version:a.Profile.Version||null,assets:a.Assets?.map(i=>i.Id)??[]}:n}else return n}catch(r){throw new Error(r)}}}function N(e){return async t=>{try{let n=await m({processId:c.profileRegistry,action:"Get-Metadata-By-ProfileIds",data:{ProfileIds:t.profileIds},ao:e.ao});return n&&n.length?t.profileIds.map(r=>{let o=n.find(a=>a.ProfileId===r);return{id:o?o.ProfileId:r,username:o?o.Username:null,avatar:o?o.ProfileImage:null,bio:o?o.Description??null:null,lastUpdate:Date.now()}}):[]}catch(n){throw new Error(n)}}}function C(e){return async t=>{try{let n=t.profileSrc?t.profileSrc:c.profileSrc,r=await fetch(`${e.arweaveUrl}/${n}`);if(!r.ok)throw new Error("Error fetching the process source code.");let o=await r.text(),s=[{name:"Date-Created",value:new Date().getTime().toString()},{name:"Action",value:"Create-Profile"}];e.logging&&console.log("Spawning profile process...");let i=await e.ao.spawn({module:t.module?t.module:c.module,scheduler:t.scheduler?t.scheduler:c.scheduler,signer:e.signer,tags:s,data:JSON.stringify(y(t.data))});e.logging&&console.log("Process Id -",i),e.logging&&console.log("Fetching profile process...");let g=null,u=0;for(;!g;){await new Promise(R=>setTimeout(R,2e3));let l=await v({gateway:e.graphqlUrl,ids:[i],tagFilters:null,owners:null,cursor:null});if(l&&l.data.length)e.logging&&console.log("Fetched transaction -",l.data[0].node.id),g=l.data[0].node.id;else if(e.logging&&console.log("Transaction not found -",i),u++,u>=200)throw new Error("Profile not found, please try again")}e.logging&&console.log("Sending source eval...");let f=await e.ao.message({process:i,signer:e.signer,tags:[{name:"Action",value:"Eval"}],data:o});e.logging&&console.log(f);let d=await e.ao.result({message:f,process:i});return e.logging&&console.log(d),await new Promise(l=>setTimeout(l,1e3)),e.logging&&console.log("Updating profile data..."),await I({processId:i,action:"Update-Profile",tags:null,data:JSON.stringify(y(t.data)),ao:e.ao,signer:e.signer}),i}catch(n){throw new Error(n)}}}function D(e){return async t=>(e.logging&&console.log(`Updating Profile ${t.profileId}`),(await I({processId:t.profileId,action:"Update-Profile",tags:[{name:"ProfileProcess",value:t.profileId}],data:JSON.stringify(y(t.data)),ao:e.ao,signer:e.signer}))["Profile-Success"]?.id)}var B=e=>({create:C({ao:e.ao,signer:e.signer,arweaveUrl:e?.arweaveUrl?e.arweaveUrl:T,graphqlUrl:e?.graphqlUrl?e.graphqlUrl:p.goldsky,logging:e.logging}),update:D({ao:e.ao,signer:e.signer,logging:e.logging}),getById:A({ao:e.ao}),getByWallet:S({ao:e.ao}),getRegistryProfiles:N({ao:e.ao})});export{B as init};
//# sourceMappingURL=index.esm.js.map
