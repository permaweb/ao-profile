var J=Object.create;var U=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var Z=Object.getPrototypeOf,K=Object.prototype.hasOwnProperty;var V=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var j=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Y(t))!K.call(e,o)&&o!==r&&U(e,o,{get:()=>t[o],enumerable:!(n=_(t,o))||n.enumerable});return e};var c=(e,t,r)=>(r=e!=null?J(Z(e)):{},j(t||!e||!e.__esModule?U(r,"default",{value:e,enumerable:!0}):r,e));var u=V((se,L)=>{var i=L.exports={},p,f;function N(){throw new Error("setTimeout has not been defined")}function R(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?p=setTimeout:p=N}catch{p=N}try{typeof clearTimeout=="function"?f=clearTimeout:f=R}catch{f=R}})();function q(e){if(p===setTimeout)return setTimeout(e,0);if((p===N||!p)&&setTimeout)return p=setTimeout,setTimeout(e,0);try{return p(e,0)}catch{try{return p.call(null,e,0)}catch{return p.call(this,e,0)}}}function z(e){if(f===clearTimeout)return clearTimeout(e);if((f===R||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(e);try{return f(e)}catch{try{return f.call(null,e)}catch{return f.call(this,e)}}}var d=[],v=!1,w,x=-1;function H(){!v||!w||(v=!1,w.length?d=w.concat(d):x=-1,d.length&&D())}function D(){if(!v){var e=q(H);v=!0;for(var t=d.length;t;){for(w=d,d=[];++x<t;)w&&w[x].run();x=-1,t=d.length}w=null,v=!1,z(e)}}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];d.push(new E(e,t)),d.length===1&&!v&&q(D)};function E(e,t){this.fun=e,this.array=t}E.prototype.run=function(){this.fun.apply(null,this.array)};i.title="browser";i.browser=!0;i.env={};i.argv=[];i.version="";i.versions={};function m(){}i.on=m;i.addListener=m;i.once=m;i.off=m;i.removeListener=m;i.removeAllListeners=m;i.emit=m;i.prependListener=m;i.prependOnceListener=m;i.listeners=function(e){return[]};i.binding=function(e){throw new Error("process.binding is not supported")};i.cwd=function(){return"/"};i.chdir=function(e){throw new Error("process.chdir is not supported")};i.umask=function(){return 0}});var Pe=c(u(),1);var ge=c(u(),1);var ae=c(u(),1),B="https://arweave.net",T={profileSrc:"_R2XYWDPUXVvQrQKFaQRvDTDcDwnQNbqlTd_qvCRSpQ",module:"Pq2Zftrqut0hdisH_MC2pDOT6S4eQFoxGsFUzR6r350",scheduler:"_GQ33BkPtZrqxA84vM8Zk-N2aO0toNNu_C-l-rawrBA",profileRegistry:"SNy4m-DrqxWl01YqGM4sxI8qCni-58re8uuJLvZPypY"},A={arweave:"https://arweave.net",goldsky:"https://arweave-search.goldsky.com"},Q={default:100,landing:{assets:30},collection:{assets:15},profile:{assets:15}},C={p1:"P1",end:"END"};function X(e){let t=e.paginator?e.paginator:Q.default,r=e.ids?JSON.stringify(e.ids):null,n=null;e.minBlock!==void 0&&e.minBlock!==null&&(n={},n.min=e.minBlock);let o=n?JSON.stringify(n).replace(/"([^"]+)":/g,"$1:"):null,s=e.tagFilters?JSON.stringify(e.tagFilters).replace(/"(name)":/g,"$1:").replace(/"(values)":/g,"$1:").replace(/"FUZZY_OR"/g,"FUZZY_OR"):null,a=e.owners?JSON.stringify(e.owners):null,l=e.cursor&&e.cursor!==C.end?`"${e.cursor}"`:null,h=`first: ${t}`,y="",P="data { size type } owner { address } block { height timestamp }",I="";switch(e.gateway){case A.arweave:break;case A.goldsky:y="count";break}let g=`
		transactions(
				ids: ${r},
				tags: ${s},
				${h}
				owners: ${a},
				block: ${o},
				after: ${l},
				${I}
				
			){
			${y}
				pageInfo {
					hasNextPage
				}
				edges {
					cursor
					node {
						id
						tags {
							name 
							value 
						}
						${P}
					}
				}
		}`;return e.queryKey&&(g=`${e.queryKey}: ${g}`),g}async function ee(e){try{return await(await fetch(`${e.gateway}/graphql`,{method:"POST",headers:{"Content-Type":"application/json"},body:e.query})).json()}catch(t){throw t}}function te(e){let t={query:`query { ${e} }`};return JSON.stringify(t)}async function $(e){let t=e.paginator?e.paginator:Q.default,r=[],n=0,o=null;if(e.ids&&!e.ids.length)return{data:r,count:n,nextCursor:o,previousCursor:null};try{let s=X(e),a=await ee({gateway:e.gateway,query:te(s)});return a.data.transactions.edges.length?(r=[...a.data.transactions.edges],n=a.data.transactions.count??0,r.length<t||!a.data.transactions.pageInfo.hasNextPage?o=C.end:o=r[r.length-1].cursor,{data:r,count:n,nextCursor:o,previousCursor:null}):{data:r,count:n,nextCursor:o,previousCursor:null}}catch(s){return console.error(s),{data:r,count:n,nextCursor:o,previousCursor:null}}}function G(e,t){for(let r=0;r<e.length;r++)if(e[r]&&e[r].name===t)return e[r].value;return null}async function O(e){try{let t=[{name:"Action",value:e.action}];e.tags&&t.push(...e.tags);let r=e.data,n=await e.ao.message({process:e.processId,signer:e.signer,tags:t,data:r}),{Messages:o}=await e.ao.result({message:n,process:e.processId});if(o&&o.length){let s={};return o.forEach(a=>{let l=G(a.Tags,"Action")||e.action,h=null,y=a.Data;if(y)try{h=JSON.parse(y)}catch{h=y}let P=G(a.Tags,"Status"),I=G(a.Tags,"Message");s[l]={id:n,status:P,message:I,data:h}}),s}else return null}catch(t){console.error(t)}}function b(e){return Object.fromEntries(Object.entries(e).map(([t,r])=>[t.charAt(0).toUpperCase()+t.slice(1),r]))}var fe=c(u(),1);async function S(e){let t=[{name:"Action",value:e.action}];e.tags&&t.push(...e.tags);let r=JSON.stringify(e.data||{}),n=await e.ao.dryrun({process:e.processId,tags:t,data:r});if(n.Messages&&n.Messages.length){if(n.Messages[0].Data)return JSON.parse(n.Messages[0].Data);if(n.Messages[0].Tags)return n.Messages[0].Tags.reduce((o,s)=>(o[s.name]=s.value,o),{})}}function k(e){return async t=>{let r={id:t.profileId,walletAddress:null,displayName:null,username:null,bio:null,avatar:null,banner:null,version:null};try{let n=await S({processId:t.profileId,action:"Info",data:null,ao:e.ao});return n?{id:t.profileId,walletAddress:n.Owner||null,displayName:n.Profile.DisplayName||null,username:n.Profile.UserName||null,bio:n.Profile.Description||null,avatar:n.Profile.ProfileImage||null,banner:n.Profile.CoverImage||null,version:n.Profile.Version||null,assets:n.Assets?.map(o=>o.Id)??[]}:r}catch(n){throw new Error(n)}}}function F(e){return async t=>{let r={id:null,walletAddress:t.address,displayName:null,username:null,bio:null,avatar:null,banner:null,version:null};try{let n=await S({processId:e.registry?e.registry:T.profileRegistry,action:"Get-Profiles-By-Delegate",data:{Address:t.address},ao:e.ao}),o=null;if(n&&n.length>0&&n[0].ProfileId&&(o=n[0].ProfileId),o){let s=await S({processId:o,action:"Info",data:null,ao:e.ao});return s?{id:o,walletAddress:s.Owner||null,displayName:s.Profile.DisplayName||null,username:s.Profile.UserName||null,bio:s.Profile.Description||null,avatar:s.Profile.ProfileImage||null,banner:s.Profile.CoverImage||null,version:s.Profile.Version||null,assets:s.Assets?.map(l=>l.Id)??[]}:r}else return r}catch(n){throw new Error(n)}}}function W(e){return async t=>{try{let r=await S({processId:e.registry?e.registry:T.profileRegistry,action:"Get-Metadata-By-ProfileIds",data:{ProfileIds:t.profileIds},ao:e.ao});return r&&r.length?t.profileIds.map(n=>{let o=r.find(s=>s.ProfileId===n);return{id:o?o.ProfileId:n,username:o?o.Username:null,avatar:o?o.ProfileImage:null,bio:o?o.Description??null:null,lastUpdate:Date.now()}}):[]}catch(r){throw new Error(r)}}}var ye=c(u(),1);function re(e){return async t=>{try{let r=t.profileSrc?t.profileSrc:T.profileSrc,n=await fetch(`${e.arweaveUrl}/${r}`);if(!n.ok)throw new Error("Error fetching the process source code.");let o=await n.text(),a=[{name:"Date-Created",value:new Date().getTime().toString()},{name:"Action",value:"Create-Profile"}];e.logging&&console.log("Spawning profile process...");let l=await e.ao.spawn({module:t.module?t.module:T.module,scheduler:t.scheduler?t.scheduler:T.scheduler,signer:e.signer,tags:a,data:JSON.stringify(b(t.data))});e.logging&&console.log("Process Id -",l),e.logging&&console.log("Fetching profile process...");let h=null,y=0;for(;!h;){await new Promise(M=>setTimeout(M,2e3));let g=await $({gateway:e.graphqlUrl,ids:[l],tagFilters:null,owners:null,cursor:null});if(g&&g.data.length)e.logging&&console.log("Fetched transaction -",g.data[0].node.id),h=g.data[0].node.id;else if(e.logging&&console.log("Transaction not found -",l),y++,y>=200)throw new Error("Profile not found, please try again")}e.logging&&console.log("Sending source eval...");let P=await e.ao.message({process:l,signer:e.signer,tags:[{name:"Action",value:"Eval"}],data:o});e.logging&&console.log(P);let I=await e.ao.result({message:P,process:l});return e.logging&&console.log(I),await new Promise(g=>setTimeout(g,1e3)),e.logging&&console.log("Updating profile data..."),await O({processId:l,action:"Update-Profile",tags:null,data:JSON.stringify(b(t.data)),ao:e.ao,signer:e.signer}),l}catch(r){throw new Error(r)}}}function ne(e){return async t=>(e.logging&&console.log(`Updating Profile ${t.profileId}`),(await O({processId:t.profileId,action:"Update-Profile",tags:[{name:"ProfileProcess",value:t.profileId}],data:JSON.stringify(b(t.data)),ao:e.ao,signer:e.signer}))["Profile-Success"]?.id)}var we=e=>({create:re({ao:e.ao,signer:e.signer,arweaveUrl:e?.arweaveUrl?e.arweaveUrl:B,graphqlUrl:e?.graphqlUrl?e.graphqlUrl:A.goldsky,logging:e.logging}),update:ne({ao:e.ao,signer:e.signer,logging:e.logging}),getById:k({ao:e.ao,registry:e.registry}),getByWallet:F({ao:e.ao,registry:e.registry}),getRegistryProfiles:W({ao:e.ao,registry:e.registry})});export{we as init};
//# sourceMappingURL=index.js.map
