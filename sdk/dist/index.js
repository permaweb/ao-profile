var K=Object.create;var L=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var re=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ne=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of X(t))!te.call(e,a)&&a!==r&&L(e,a,{get:()=>t[a],enumerable:!(n=H(t,a))||n.enumerable});return e};var g=(e,t,r)=>(r=e!=null?K(ee(e)):{},ne(t||!e||!e.__esModule?L(r,"default",{value:e,enumerable:!0}):r,e));var u=re((we,$)=>{var i=$.exports={},c,f;function R(){throw new Error("setTimeout has not been defined")}function C(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?c=setTimeout:c=R}catch{c=R}try{typeof clearTimeout=="function"?f=clearTimeout:f=C}catch{f=C}})();function q(e){if(c===setTimeout)return setTimeout(e,0);if((c===R||!c)&&setTimeout)return c=setTimeout,setTimeout(e,0);try{return c(e,0)}catch{try{return c.call(null,e,0)}catch{return c.call(this,e,0)}}}function ae(e){if(f===clearTimeout)return clearTimeout(e);if((f===C||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(e);try{return f(e)}catch{try{return f.call(null,e)}catch{return f.call(this,e)}}}var p=[],I=!1,w,x=-1;function oe(){!I||!w||(I=!1,w.length?p=w.concat(p):x=-1,p.length&&k())}function k(){if(!I){var e=q(oe);I=!0;for(var t=p.length;t;){for(w=p,p=[];++x<t;)w&&w[x].run();x=-1,t=p.length}w=null,I=!1,ae(e)}}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];p.push(new W(e,t)),p.length===1&&!I&&q(k)};function W(e,t){this.fun=e,this.array=t}W.prototype.run=function(){this.fun.apply(null,this.array)};i.title="browser";i.browser=!0;i.env={};i.argv=[];i.version="";i.versions={};function y(){}i.on=y;i.addListener=y;i.once=y;i.off=y;i.removeListener=y;i.removeAllListeners=y;i.emit=y;i.prependListener=y;i.prependOnceListener=y;i.listeners=function(e){return[]};i.binding=function(e){throw new Error("process.binding is not supported")};i.cwd=function(){return"/"};i.chdir=function(e){throw new Error("process.chdir is not supported")};i.umask=function(){return 0}});var Oe=g(u(),1);import{Buffer as ye}from"buffer";var Ie=g(u(),1);var Pe=g(u(),1),F="https://arweave.net",T={profileSrc:"_R2XYWDPUXVvQrQKFaQRvDTDcDwnQNbqlTd_qvCRSpQ",module:"Pq2Zftrqut0hdisH_MC2pDOT6S4eQFoxGsFUzR6r350",scheduler:"_GQ33BkPtZrqxA84vM8Zk-N2aO0toNNu_C-l-rawrBA",profileRegistry:"SNy4m-DrqxWl01YqGM4sxI8qCni-58re8uuJLvZPypY"},A={arweave:"https://arweave.net",goldsky:"https://arweave-search.goldsky.com"},E={default:100,landing:{assets:30},collection:{assets:15},profile:{assets:15}},Q={p1:"P1",end:"END"},M={keys:{contentType:"Content-Type"}},z={node1:"https://up.arweave.net",node2:"https://turbo.ardrive.io",batchSize:1,chunkSize:75e5,dispatchUploadSize:100*1024};function ie(e){let t=e.paginator?e.paginator:E.default,r=e.ids?JSON.stringify(e.ids):null,n=null;e.minBlock!==void 0&&e.minBlock!==null&&(n={},n.min=e.minBlock);let a=n?JSON.stringify(n).replace(/"([^"]+)":/g,"$1:"):null,o=e.tagFilters?JSON.stringify(e.tagFilters).replace(/"(name)":/g,"$1:").replace(/"(values)":/g,"$1:").replace(/"FUZZY_OR"/g,"FUZZY_OR"):null,s=e.owners?JSON.stringify(e.owners):null,d=e.cursor&&e.cursor!==Q.end?`"${e.cursor}"`:null,h=`first: ${t}`,m="",P="data { size type } owner { address } block { height timestamp }",l="";switch(e.gateway){case A.arweave:break;case A.goldsky:m="count";break}let v=`
		transactions(
				ids: ${r},
				tags: ${o},
				${h}
				owners: ${s},
				block: ${a},
				after: ${d},
				${l}
				
			){
			${m}
				pageInfo {
					hasNextPage
				}
				edges {
					cursor
					node {
						id
						tags {
							name 
							value 
						}
						${P}
					}
				}
		}`;return e.queryKey&&(v=`${e.queryKey}: ${v}`),v}async function se(e){try{return await(await fetch(`${e.gateway}/graphql`,{method:"POST",headers:{"Content-Type":"application/json"},body:e.query})).json()}catch(t){throw t}}function le(e){let t={query:`query { ${e} }`};return JSON.stringify(t)}async function J(e){let t=e.paginator?e.paginator:E.default,r=[],n=0,a=null;if(e.ids&&!e.ids.length)return{data:r,count:n,nextCursor:a,previousCursor:null};try{let o=ie(e),s=await se({gateway:e.gateway,query:le(o)});return s.data.transactions.edges.length?(r=[...s.data.transactions.edges],n=s.data.transactions.count??0,r.length<t||!s.data.transactions.pageInfo.hasNextPage?a=Q.end:a=r[r.length-1].cursor,{data:r,count:n,nextCursor:a,previousCursor:null}):{data:r,count:n,nextCursor:a,previousCursor:null}}catch(o){return console.error(o),{data:r,count:n,nextCursor:a,previousCursor:null}}}function B(e,t){for(let r=0;r<e.length;r++)if(e[r]&&e[r].name===t)return e[r].value;return null}async function D(e){try{let t=[{name:"Action",value:e.action}];e.tags&&t.push(...e.tags);let r=e.data,n=await e.ao.message({process:e.processId,signer:e.signer,tags:t,data:r}),{Messages:a}=await e.ao.result({message:n,process:e.processId});if(a&&a.length){let o={};return a.forEach(s=>{let d=B(s.Tags,"Action")||e.action,h=null,m=s.Data;if(m)try{h=JSON.parse(m)}catch{h=m}let P=B(s.Tags,"Status"),l=B(s.Tags,"Message");o[d]={id:n,status:P,message:l,data:h}}),o}else return null}catch(t){console.error(t)}}function S(e){return Object.fromEntries(Object.entries(e).map(([t,r])=>[t.charAt(0).toUpperCase()+t.slice(1),r]))}function ue(e){return e?/^[a-z0-9_-]{43}$/i.test(e):!1}function ge(e){return e.split(",")[1]}function ce(e){let t=e.match(/^data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+);base64,/);return t?t[1]:null}function fe(e){let t;if(Buffer.isBuffer(e))t=e.length;else if(typeof e=="string")t=Buffer.byteLength(e,"utf-8");else throw new Error("Input must be a string or a Buffer");return t}async function pe(e){let t=null,r=null;try{typeof e.data=="string"&&e.data.startsWith("data:")&&(t=Buffer.from(ge(e.data),"base64"),r=ce(e.data))}catch(n){throw new Error(n)}if(t&&r)if(fe(t)<Number(z.dispatchUploadSize)){let a=await e.arweave.createTransaction({data:t},"use_wallet");return a.addTag(M.keys.contentType,r),e.tags&&e.tags.length>0&&e.tags.forEach(o=>a.addTag(o.name,o.value)),global.window&&global.window.arweaveWallet?(await global.window.arweaveWallet.dispatch(a)).id:""}else throw new Error("Data exceeds max upload limit");else throw new Error("Error preparing transaction data")}function O(e){return async t=>{if(!t)return"";if(ue(t))return t;try{return await pe({data:t,arweave:e.arweave})}catch(r){throw new Error(r.message??"Error resolving transaction")}}}var Se=g(u(),1);async function N(e){let t=[{name:"Action",value:e.action}];e.tags&&t.push(...e.tags);let r=JSON.stringify(e.data||{}),n=await e.ao.dryrun({process:e.processId,tags:t,data:r});if(n.Messages&&n.Messages.length){if(n.Messages[0].Data)return JSON.parse(n.Messages[0].Data);if(n.Messages[0].Tags)return n.Messages[0].Tags.reduce((a,o)=>(a[o.name]=o.value,a),{})}}function _(e){return async t=>{let r={id:t.profileId,walletAddress:null,displayName:null,username:null,description:null,thumbnail:null,banner:null,version:null};try{let n=await N({processId:t.profileId,action:"Info",data:null,ao:e.ao});return n?{id:t.profileId,walletAddress:n.Owner||null,displayName:n.Profile.DisplayName||null,username:n.Profile.UserName||null,description:n.Profile.Description||null,thumbnail:n.Profile.ProfileImage||null,banner:n.Profile.CoverImage||null,version:n.Profile.Version||null,assets:n.Assets?.map(a=>a.Id)??[]}:r}catch(n){throw new Error(n)}}}function Z(e){return async t=>{let r={id:null,walletAddress:t.address,displayName:null,username:null,description:null,thumbnail:null,banner:null,version:null};try{let n=await N({processId:e.registry?e.registry:T.profileRegistry,action:"Get-Profiles-By-Delegate",data:{Address:t.address},ao:e.ao}),a=null;if(n&&n.length>0&&n[0].ProfileId&&(a=n[0].ProfileId),a){let o=await N({processId:a,action:"Info",data:null,ao:e.ao});return o?{id:a,walletAddress:o.Owner||null,displayName:o.Profile.DisplayName||null,username:o.Profile.UserName||null,description:o.Profile.Description||null,thumbnail:o.Profile.ProfileImage||null,banner:o.Profile.CoverImage||null,version:o.Profile.Version||null,assets:o.Assets?.map(d=>d.Id)??[]}:r}else return r}catch(n){throw new Error(n)}}}function Y(e){return async t=>{try{let r=await N({processId:e.registry?e.registry:T.profileRegistry,action:"Get-Metadata-By-ProfileIds",data:{ProfileIds:t.profileIds},ao:e.ao});return r&&r.length?t.profileIds.map(n=>{let a=r.find(o=>o.ProfileId===n);return{id:a?a.ProfileId:n,username:a?a.Username:null,thumbnail:a?a.ProfileImage:null,description:a?a.Description??null:null,lastUpdate:Date.now().toString()}}):[]}catch(r){throw new Error(r)}}}var Ne=g(u(),1);globalThis.Buffer||(globalThis.Buffer=ye);function de(e){return async t=>{try{let r=t.profileSrc?t.profileSrc:T.profileSrc,n=await fetch(`${e.arweaveUrl}/${r}`);if(!n.ok)throw new Error("Error fetching the process source code.");let a=await n.text(),s=[{name:"Date-Created",value:new Date().getTime().toString()},{name:"Action",value:"Create-Profile"}],{thumbnail:d,banner:h,...m}=t.data,P={...m,ProfileImage:await e.resolveTransaction(d),CoverImage:await e.resolveTransaction(h)};e.logging&&console.log("Spawning profile process...");let l=await e.ao.spawn({module:t.module?t.module:T.module,scheduler:t.scheduler?t.scheduler:T.scheduler,signer:e.signer,tags:s,data:JSON.stringify(S(P))});e.logging&&console.log("Process Id -",l),e.logging&&console.log("Fetching profile process...");let v=null,U=0;for(;!v;){await new Promise(j=>setTimeout(j,2e3));let b=await J({gateway:e.graphqlUrl,ids:[l],tagFilters:null,owners:null,cursor:null});if(b&&b.data.length)e.logging&&console.log("Fetched transaction -",b.data[0].node.id),v=b.data[0].node.id;else if(e.logging&&console.log("Transaction not found -",l),U++,U>=200)throw new Error("Profile not found, please try again")}e.logging&&console.log("Sending source eval...");let G=await e.ao.message({process:l,signer:e.signer,tags:[{name:"Action",value:"Eval"}],data:a});e.logging&&console.log(G);let V=await e.ao.result({message:G,process:l});return e.logging&&console.log(V),await new Promise(b=>setTimeout(b,1e3)),e.logging&&console.log("Updating profile data..."),await D({processId:l,action:"Update-Profile",tags:null,data:JSON.stringify(S(P)),ao:e.ao,signer:e.signer}),l}catch(r){throw new Error(r)}}}function me(e){return async t=>{e.logging&&console.log(`Updating Profile ${t.profileId}`);let{thumbnail:r,banner:n,...a}=t.data,o={...a,ProfileImage:await e.resolveTransaction(r),CoverImage:await e.resolveTransaction(n)};return(await D({processId:t.profileId,action:"Update-Profile",tags:[{name:"ProfileProcess",value:t.profileId}],data:JSON.stringify(S(o)),ao:e.ao,signer:e.signer}))["Profile-Success"]?.id}}var Be=e=>({createProfile:de({ao:e.ao,signer:e.signer,arweaveUrl:e?.arweaveUrl?e.arweaveUrl:F,graphqlUrl:e?.graphqlUrl?e.graphqlUrl:A.goldsky,logging:e.logging,resolveTransaction:O({arweave:e.arweave})}),updateProfile:me({ao:e.ao,signer:e.signer,logging:e.logging,resolveTransaction:O({arweave:e.arweave})}),getProfileById:_({ao:e.ao,registry:e.registry}),getProfileByWalletAddress:Z({ao:e.ao,registry:e.registry}),getRegistryProfiles:Y({ao:e.ao,registry:e.registry})});export{Be as initAOProfile};
//# sourceMappingURL=index.js.map
